<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<!--
Collect source to be instrumented for code coverage
-->
<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<target name="collect">
<copy todir="${instrumentedSourceDir}">
<fileset dir="${test-dir}"/>
</copy>
</target>
<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<!-- Instrument sources for code coverage -->
<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<target name="instrument-sources" depends="collect">
<codecover>
<instrument containerId="c" language="java" destination="${instrumentedSourceDir}" charset="utf-8" copyUninstrumented="yes">
<source dir="${src-dir}">
<include name="**/*.java"/>
</source>
</instrument>
<save containerId="c" filename="codecover.xml"/>
</codecover>
</target>
<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<!-- Compile source with instrumentation -->
<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<target name="compile-instrumented" depends="instrument-sources">
<javac srcdir="${instrumentedSourceDir}" destdir="${instrumentedSourceDir}" encoding="utf-8" target="1.5" debug="true" classpath="${codecoverDir}/lib/codecover-instrumentation-java.jar" includeAntRuntime="false">
</javac>
</target>
<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<!-- Run source with instrumentation -->
<!--
TODO: change to using Junit to run instead of calling Junit directly
-->
<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<target name="run-instrumented" depends="compile-instrumented">
<java fork="true" classname="org.codecover.junit4.core.TestRunner">
<classpath>
<!-- code cover jars -->
<pathelement location="${codecoverDir}/lib/JUnit-TestRunner.jar"/>
<pathelement location="${codecoverDir}/lib/codecover-ant.jar"/>
<pathelement location="${codecoverDir}/lib/codecover-batch.jar"/>
<pathelement location="${codecoverDir}/lib/codecover-core.jar"/>
<pathelement path="${instrumentedSourceDir}"/>
</classpath>
<jvmarg value="-Dorg.codecover.coverage-log-file=test.clf"/>
<arg value="${master-test-suite}"/>
</java>
</target>
<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<!-- Create Coverage Report -->
<!--
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-->
<target name="create-report" depends="run-instrumented">
<codecover>
<load containerId="c" filename="codecover.xml"/>
<analyze containerId="c" coverageLog="test.clf" name="Test Session"/>
<save containerId="c" filename="codecover.xml"/>
<report containerId="c" destination="report.html" template="${codecoverDir}/report-templates/HTML_Report_hierarchic.xml">
<testCases>
<testSession pattern=".*">
<testCase pattern=".*"/>
</testSession>
</testCases>
</report>
</codecover>
</target>